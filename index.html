<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Red de Farmacias – Línea Dolor | Alef Medical</title>

  <!-- SheetJS (leer Excel en el browser) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --max: 1100px;
      --pad: 16px;
      --bg: #ffffff;
      --text: #1c1c1c;
      --muted: #5b5b5b;
      --line: #e8e8e8;
      --line2:#f0f0f0;
      --green:#2bb673; /* línea verde */
      --blue:#1f2a44;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --radius: 14px;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    img{ max-width:100%; display:block; }

    .container{
      max-width: var(--max);
      margin: 0 auto;
      padding: 0 var(--pad);
    }

    /* ---------- Header ---------- */
    header{
      padding: 26px 0 0;
      border-bottom: 1px solid var(--line);
    }

    .brand-top{
      display:flex;
      flex-direction: column;
      align-items:center;
      gap: 8px;
      padding-bottom: 14px;
    }
    .brand-top img{
      height: 62px;
      width: auto;
      object-fit: contain;
    }
    .brand-top .brand-text{
      font-size: 14px;
      color: var(--muted);
      letter-spacing: .2px;
    }

    .green-sep{
      height: 4px;
      background: var(--green);
      width: 100%;
    }

    .brand-row{
      padding: 18px 0 14px;
    }
    .brand-row-grid{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap: 14px;
    }
    .brand-row-grid .left{ justify-self:start; }
    .brand-row-grid .right{ justify-self:end; }
    .brand-row-grid img{
      height: 56px;
      width:auto;
      object-fit:contain;
    }
    .brand-row-grid h1{
      margin:0;
      font-size: 28px;
      color: var(--blue);
      text-align:center;
      line-height: 1.1;
      letter-spacing: .2px;
    }

    .soft-sep{
      height: 1px;
      background: var(--line);
      width: 100%;
    }

    /* ---------- Filters Card ---------- */
    .filters-wrap{
      padding: 18px 0 10px;
    }
    .card{
      background:#fff;
      border: 1px solid var(--line2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .filters-grid{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items:end;
    }
    label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    select, input, textarea{
      width:100%;
      padding: 11px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      font-size: 15px;
      outline: none;
      background:#fff;
    }
    select:focus, input:focus, textarea:focus{
      border-color: rgba(43,182,115,.65);
      box-shadow: 0 0 0 3px rgba(43,182,115,.15);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(31,42,68,.18);
      background: #fff;
      color: var(--blue);
      cursor:pointer;
      font-weight: 700;
      font-size: 14px;
      white-space:nowrap;
      height: 44px;
    }
    .btn:hover{ box-shadow: 0 10px 25px rgba(0,0,0,.06); }

    .hint{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }

    /* ---------- List ---------- */
    .list-header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      margin: 14px 0 10px;
    }
    .status{
      font-size: 14px;
      color: var(--muted);
    }

    .list{
      border: 1px solid var(--line2);
      border-radius: var(--radius);
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow);
    }
    .row{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line2);
    }
    .row:last-child{ border-bottom:none; }
    .row h3{
      margin: 0 0 6px;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap: 8px 14px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(31,42,68,.06);
      color: var(--blue);
      font-size: 12px;
      font-weight: 700;
    }
    .empty{
      padding: 18px 16px;
      color: var(--muted);
      font-size: 14px;
    }

    /* ---------- TOTAX ---------- */
    .section-sep{
      height: 1px;
      background: var(--line);
      width: 100%;
      margin: 24px 0;
    }
    .totax{
      text-align:center;
      padding-bottom: 6px;
    }
    .totax img{
      max-width: 520px;   /* moderado */
      width: 100%;
      border-radius: 14px;
      box-shadow: var(--shadow);
    }

    /* ---------- Footer / Contact ---------- */
    footer{
      padding: 8px 0 34px;
    }
    .contact-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .contact-grid .full{ grid-column: 1 / -1; }
    textarea{ min-height: 110px; resize: vertical; }

    .form-actions{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:flex-start;
      margin-top: 10px;
    }
    .btn-primary{
      background: var(--blue);
      color:#fff;
      border-color: rgba(31,42,68,.25);
    }
    .btn-primary:hover{ opacity:.96; }

    .msg{
      font-size: 14px;
      color: var(--muted);
    }
    .msg.ok{ color: #157347; }
    .msg.err{ color: #b00020; }

    /* ---------- Responsive ---------- */
    @media (max-width: 860px){
      .filters-grid{ grid-template-columns: 1fr; }
      .btn{ width: 100%; }
      .brand-row-grid{
        grid-template-columns: 1fr;
        justify-items:center;
      }
      .brand-row-grid .left, .brand-row-grid .right{ justify-self:center; }
      .brand-row-grid h1{ font-size: 24px; }
      .contact-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<header>
  <div class="container">
    <div class="brand-top">
      <img src="logo_alefmedical.png" alt="Alef Medical" onerror="this.style.display='none';document.getElementById('alefFallback').style.display='block';" />
      <div id="alefFallback" style="display:none;font-weight:700;color:var(--blue);font-size:18px;">Alef Medical</div>
      <div class="brand-text">Alef Medical Argentina</div>
    </div>
  </div>

  <div class="green-sep"></div>

  <div class="container brand-row">
    <div class="brand-row-grid">
      <div class="left">
        <img src="Logo_Oramorph_color.png" alt="Oramorph" onerror="this.style.display='none';" />
      </div>

      <h1>Red de Farmacias</h1>

      <div class="right">
        <img src="Logo_Alefdona_color.png" alt="Alefdona" onerror="this.style.display='none';" />
      </div>
    </div>
  </div>

  <div class="soft-sep"></div>
</header>

<main class="container">
  <!-- Filtros -->
  <section class="filters-wrap">
    <div class="card">
      <div class="filters-grid">
        <div>
          <label for="provinciaSelect">Provincia</label>
          <select id="provinciaSelect" aria-label="Filtrar por provincia">
            <option value="" selected>Sin filtro</option>
            <!-- dinámico -->
          </select>
        </div>

        <div>
          <label for="localidadInput">Localidad</label>
          <!-- Autocomplete via datalist -->
          <input id="localidadInput" list="localidadesList" placeholder="Escribí para buscar (opcional)" autocomplete="off" />
          <datalist id="localidadesList"></datalist>
        </div>

        <div>
          <button class="btn" id="todoPaisBtn" type="button" aria-label="Mostrar todo el país">
            Todo el País
          </button>
        </div>
      </div>

      <div class="hint">
        Al ingresar se muestran <b>todas</b> las farmacias. Usá los filtros solo si necesitás acotar la búsqueda.
      </div>
    </div>
  </section>

  <!-- Estado + Listado -->
  <section>
    <div class="list-header">
      <div class="status" id="statusText">Cargando listado…</div>
      <div class="pill" id="pillInfo" style="display:none;"></div>
    </div>

    <div class="list" id="farmaciasList">
      <div class="empty">Cargando…</div>
    </div>
  </section>

  <!-- TOTAX -->
  <div class="section-sep"></div>
  <section class="totax" aria-label="Banner TOTAX">
    <a href="https://Totax.com.ar" target="_blank" rel="noopener noreferrer">
      <img src="banner_totax.png" alt="TOTAX" onerror="this.style.display='none';" />
    </a>
  </section>
</main>

<!-- Footer Contacto -->
<div class="section-sep"></div>
<footer class="container">
  <h2 style="margin:0 0 12px;color:var(--blue);font-size:20px;">Contacto</h2>

  <div class="card">
    <form id="contactForm" novalidate>
      <div class="contact-grid">
        <div>
          <label for="nombreApellido">Nombre y apellido</label>
          <input id="nombreApellido" name="name" type="text" required placeholder="Ej: Germán Begani" />
        </div>

        <div>
          <label for="celular">Celular</label>
          <input id="celular" name="phone" type="tel" required placeholder="Ej: +54 9 11 1234-5678" />
        </div>

        <div class="full">
          <label for="consulta">Consulta</label>
          <textarea id="consulta" name="message" required placeholder="Escribí tu consulta…"></textarea>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" id="sendBtn" type="submit">Enviar</button>
        <div class="msg" id="formMsg"></div>
      </div>

      <div class="hint" style="margin-top:12px;">
        Tu consulta se envía mediante un endpoint <code>/api/contact</code> (no se expone el email destino en esta página).
      </div>
    </form>
  </div>
</footer>

<script>
  // -----------------------------
  // 1) Lectura Excel + Mapeo
  // -----------------------------
  let allRows = [];     // canonical rows
  let filteredRows = []; // currently shown

  const provinciaSelect = document.getElementById('provinciaSelect');
  const localidadInput  = document.getElementById('localidadInput');
  const localidadesList = document.getElementById('localidadesList');
  const todoPaisBtn     = document.getElementById('todoPaisBtn');

  const statusText = document.getElementById('statusText');
  const pillInfo   = document.getElementById('pillInfo');
  const farmaciasList = document.getElementById('farmaciasList');

  function norm(v){
    return String(v ?? '').trim();
  }
  function low(v){
    return norm(v).toLowerCase();
  }

  // Mapeo flexible: soporta tu Excel real (name/address/locality/city/province/phoneDisplay/whatsappDisplay)
  // y también encabezados "Farmacia/Dirección/Localidad/Provincia/Teléfono" si algún día los cambiás.
  function toCanonical(row){
    const farmName = norm(row.Farmacia ?? row.farmacia ?? row.name ?? row.Nombre ?? row.nombre);
    const address  = norm(row['Dirección'] ?? row.Direccion ?? row.address ?? row.direccion);
    const prov     = norm(row.Provincia ?? row.province ?? row.provincia);
    const loc      = norm(row.Localidad ?? row.locality ?? row.city ?? row.localidad);
    const phone    = norm(row['Teléfono'] ?? row.Telefono ?? row.phoneDisplay ?? row.phone ?? row.whatsappDisplay ?? row.whatsapp);
    return {
      name: farmName || '—',
      address: address || '—',
      province: prov || '—',
      locality: loc || '—',
      phone: phone || ''
    };
  }

  async function loadExcel(){
    try{
      const res = await fetch('farmacias.xlsx', { cache: 'no-store' });
      if(!res.ok) throw new Error('No se pudo cargar farmacias.xlsx');
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });

      // usa primera hoja “útil”
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];

      const raw = XLSX.utils.sheet_to_json(sheet, { defval: '' });
      allRows = raw.map(toCanonical).filter(r => r.name !== '—' || r.address !== '—');

      // Home: mostrar todo
      buildProvinciaOptions();
      buildLocalidadesDatalist(); // sin provincia seleccionada (todas)
      applyFilters(); // sin filtros -> todo
    }catch(err){
      console.error(err);
      statusText.textContent = 'No se pudo cargar el listado.';
      pillInfo.style.display = 'none';
      farmaciasList.innerHTML = `
        <div class="empty">
          <b>No se pudo cargar el listado</b>.<br/>
          Verificá que <code>farmacias.xlsx</code> esté en la misma carpeta que este <code>index.html</code>.
        </div>`;
    }
  }

  function uniqueSorted(arr){
    const s = Array.from(new Set(arr.filter(Boolean)));
    s.sort((a,b)=>a.localeCompare(b,'es'));
    return s;
  }

  function buildProvinciaOptions(){
    // Limpio opciones (dejo "Sin filtro")
    const keep0 = provinciaSelect.options[0];
    provinciaSelect.innerHTML = '';
    provinciaSelect.appendChild(keep0);

    const provincias = uniqueSorted(allRows.map(r => r.province).filter(p => p !== '—'));
    provincias.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      provinciaSelect.appendChild(opt);
    });
  }

  function buildLocalidadesDatalist(provinciaValue = ''){
    localidadesList.innerHTML = '';
    const rows = provinciaValue
      ? allRows.filter(r => r.province === provinciaValue)
      : allRows;

    const localidades = uniqueSorted(rows.map(r => r.locality).filter(l => l !== '—'));
    localidades.forEach(l=>{
      const opt = document.createElement('option');
      opt.value = l;
      localidadesList.appendChild(opt);
    });
  }

  // -----------------------------
  // 2) Filtros + Render
  // -----------------------------
  function applyFilters(){
    const prov = norm(provinciaSelect.value);
    const loc  = norm(localidadInput.value);

    // NO filtrar si el usuario no usa filtros
    let rows = allRows;

    if(prov){
      rows = rows.filter(r => r.province === prov);
    }
    if(loc){
      rows = rows.filter(r => low(r.locality) === low(loc));
    }

    filteredRows = rows;
    renderList();
    updateStatus(prov, loc);
  }

  function updateStatus(prov, loc){
    const total = allRows.length;
    const shown = filteredRows.length;
    statusText.textContent = `Mostrando ${shown} de ${total} farmacias`;

    const tags = [];
    if(prov) tags.push(`Provincia: ${prov}`);
    if(loc)  tags.push(`Localidad: ${loc}`);

    if(tags.length){
      pillInfo.style.display = 'inline-flex';
      pillInfo.textContent = tags.join(' · ');
    }else{
      pillInfo.style.display = 'none';
    }
  }

  function renderList(){
    if(!filteredRows.length){
      farmaciasList.innerHTML = `<div class="empty">No se encontraron farmacias para los filtros seleccionados.</div>`;
      return;
    }

    const frag = document.createDocumentFragment();

    filteredRows.forEach(r=>{
      const row = document.createElement('div');
      row.className = 'row';

      const phoneLine = r.phone ? `<span><b>Tel:</b> ${escapeHtml(r.phone)}</span>` : '';
      row.innerHTML = `
        <h3>${escapeHtml(r.name)}</h3>
        <div class="meta">
          <span><b>Dirección:</b> ${escapeHtml(r.address)}</span>
          <span><b>Localidad:</b> ${escapeHtml(r.locality)}</span>
          <span><b>Provincia:</b> ${escapeHtml(r.province)}</span>
          ${phoneLine}
        </div>
      `;
      frag.appendChild(row);
    });

    farmaciasList.innerHTML = '';
    farmaciasList.appendChild(frag);
  }

  function escapeHtml(str){
    return String(str ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  // Eventos
  provinciaSelect.addEventListener('change', ()=>{
    // cascada: al cambiar provincia, refresco datalist de localidades y limpio localidad (para evitar “no match”)
    buildLocalidadesDatalist(provinciaSelect.value);
    localidadInput.value = '';
    applyFilters();
  });

  // Para no filtrar por cada tecla (mejor UX): filtro al salir del campo o al presionar Enter
  localidadInput.addEventListener('change', applyFilters);
  localidadInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      applyFilters();
    }
  });

  todoPaisBtn.addEventListener('click', ()=>{
    provinciaSelect.value = '';
    localidadInput.value = '';
    buildLocalidadesDatalist(''); // vuelve a todas
    applyFilters();
  });

  // -----------------------------
  // 3) Formulario /api/contact
  // -----------------------------
  const contactForm = document.getElementById('contactForm');
  const formMsg = document.getElementById('formMsg');
  const sendBtn = document.getElementById('sendBtn');

  function setMsg(text, type){
    formMsg.textContent = text;
    formMsg.className = 'msg' + (type ? ' ' + type : '');
  }

  contactForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    setMsg('', '');

    const name = norm(document.getElementById('nombreApellido').value);
    const phone = norm(document.getElementById('celular').value);
    const message = norm(document.getElementById('consulta').value);

    if(!name || !phone || !message){
      setMsg('Por favor completá Nombre y apellido, Celular y Consulta.', 'err');
      return;
    }

    sendBtn.disabled = true;
    sendBtn.textContent = 'Enviando…';

    try{
      const res = await fetch('/api/contact', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ name, phone, message })
      });

      if(!res.ok){
        throw new Error('Error en el envío');
      }

      setMsg('Mensaje enviado. Gracias, te contactaremos a la brevedad.', 'ok');
      contactForm.reset();
    }catch(err){
      console.error(err);
      setMsg('No se pudo enviar. Intentá nuevamente en unos minutos.', 'err');
    }finally{
      sendBtn.disabled = false;
      sendBtn.textContent = 'Enviar';
    }
  });

  // Start
  loadExcel();
</script>

</body>
</html>

